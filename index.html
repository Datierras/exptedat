<!DOCTYPE html>
<html lang="es" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Expedientes · Carga & Búsqueda</title>

  <!-- Tailwind CDN (enable dark mode via class) -->
  <script>
    tailwind = { config: { darkMode: 'class' } };
  </script>
  <script src="https://cdn.tailwindcss.com"></script>

  <link rel="stylesheet" href="./styles.css" />

  <!-- JsBarcode (Code128) -->
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js"></script>
  <!-- jsPDF (PDF en mm) -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
</head>
<body class="h-full bg-gray-50 text-gray-900 dark:bg-gray-950 dark:text-gray-100">
  <!-- Login Screen -->
  <div id="loginScreen" class="min-h-screen flex items-center justify-center p-4">
    <div class="w-full max-w-sm bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-800 rounded-2xl shadow-sm p-6 space-y-4">
      <h1 class="text-xl font-semibold text-center">Iniciar sesión</h1>
      <div class="space-y-2">
        <label for="loginEmail" class="block text-sm">Email</label>
        <input id="loginEmail" type="email" class="input" placeholder="usuario@coord.com" autocomplete="username" />
      </div>
      <div class="space-y-2">
        <label for="loginPass" class="block text-sm">Contraseña</label>
        <input id="loginPass" type="password" class="input" placeholder="********" autocomplete="current-password" />
      </div>
      <button id="btnLogin" class="btn-primary w-full">Entrar</button>
      <p id="loginMsg" class="text-sm h-5"></p>
    </div>
  </div>

  <!-- App UI -->
  <div id="appRoot" class="hidden min-h-screen">
    <div class="max-w-6xl mx-auto p-4 sm:p-6">
      <!-- Topbar -->
      <header class="mb-4 sm:mb-6 flex items-center gap-3">
        <div>
          <h1 class="text-2xl sm:text-3xl font-semibold tracking-tight">Gestión de Expedientes</h1>
          <p class="text-sm text-gray-500 dark:text-gray-400">Cargar expedientes, generar etiquetas y buscar movimientos.</p>
        </div>
        <div class="ml-auto flex items-center gap-2">
          <button id="btnConfig" class="icon-btn" title="Configuración" aria-label="Configuración">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor"><path d="M19.14,12.94a7.43,7.43,0,0,0,0-1.88l2.11-1.65a.48.48,0,0,0,.12-.61l-2-3.46a.5.5,0,0,0-.6-.22l-2.49,1a7.23,7.23,0,0,0-1.62-.94l-.38-2.65A.49.49,0,0,0,13.63,2H10.37a.49.49,0,0,0-.49.42L9.5,5.07a7.23,7.23,0,0,0-1.62.94l-2.49-1a.5.5,0,0,0-.6.22l-2,3.46a.48.48,0,0,0,.12.61L4,11.06a7.43,7.43,0,0,0,0,1.88l-2.11,1.65a.48.48,0,0,0-.12.61l2,3.46a.5.5,0,0,0,.6.22l2.49-1a7.23,7.23,0,0,0,1.62.94l.38,2.65a.49.49,0,0,0,.49.42h3.26a.49.49,0,0,0,.49-.42l.38-2.65a7.23,7.23,0,0,0,1.62-.94l2.49,1a.5.5,0,0,0,.6-.22l2-3.46a.48.48,0,0,0-.12-.61ZM12,15.5A3.5,3.5,0,1,1,15.5,12,3.5,3.5,0,0,1,12,15.5Z"/></svg>
          </button>
          <button id="btnLogout" class="icon-btn" title="Cerrar sesión" aria-label="Cerrar sesión">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor"><path d="M16 13v-2H7V8l-5 4 5 4v-3z"/><path d="M20 3h-8c-1.1 0-2 .9-2 2v4h2V5h8v14h-8v-4h-2v4c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2z"/></svg>
          </button>
        </div>
      </header>

      <!-- Tabs -->
      <div class="flex items-center gap-2 mb-4">
        <button id="tabBtnCarga" class="tab" data-active="true">CARGA</button>
        <button id="tabBtnBusqueda" class="tab" data-active="false">BÚSQUEDA</button>
      </div>

      <!-- Panels -->
      <main class="space-y-8">
        <!-- Panel CARGA -->
        <section id="panelCarga" class="card">
          <div class="card-head">
            <h2 class="title">CARGA <span class="sub">· Generar código de barras</span></h2>
          </div>
          <div class="card-body">
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4">
              <div>
                <label class="label" for="inCodigo">Código</label>
                <input id="inCodigo" type="text" inputmode="numeric" placeholder="4078" class="input" maxlength="4">
                <p class="hint">4 dígitos</p>
              </div>
              <div>
                <label class="label" for="inNumero">Número</label>
                <input id="inNumero" type="text" inputmode="numeric" placeholder="111111" class="input" maxlength="6">
                <p class="hint">6 dígitos</p>
              </div>
              <div>
                <label class="label" for="inLetra">Letra</label>
                <input id="inLetra" type="text" placeholder="I" class="input" maxlength="1">
                <p class="hint">1 letra (A–Z)</p>
              </div>
              <div>
                <label class="label" for="inAnio">Año</label>
                <input id="inAnio" type="text" inputmode="numeric" placeholder="2025" class="input" maxlength="4">
                <p class="hint">4 dígitos</p>
              </div>
              <div class="sm:col-span-2 lg:col-span-5">
                <label class="label" for="inExtracto">Extracto</label>
                <input id="inExtracto" type="text" placeholder="Breve descripción del expediente" class="input">
              </div>
            </div>

            <!-- Radios Enviamos / Recibimos -->
            <div class="mt-4 flex flex-wrap items-center gap-6">
              <span class="label">Movimiento:</span>
              <label class="inline-flex items-center gap-2">
                <input type="radio" name="movTipo" id="movEnviamos" value="Enviamos" class="radio" checked />
                <span>Enviamos</span>
              </label>
              <label class="inline-flex items-center gap-2">
                <input type="radio" name="movTipo" id="movRecibimos" value="Recibimos" class="radio" />
                <span>Recibimos</span>
              </label>
            </div>

            <!-- Nomenclatura Toggle -->
            <div class="mt-6 flex flex-col gap-4">
              <button id="showNomenclaturaBtn" class="btn-secondary w-full">Nomenclatura</button>
              <div id="nomenclatura-fields" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 hidden">
                <div class="input-group"><label for="circunscripcion" class="label">Circunscripción</label><input type="number" id="circunscripcion" class="input" min="1" max="7"></div>
                <div class="input-group"><label for="seccion" class="label">Sección</label><input type="text" id="seccion" class="input" maxlength="2" pattern="[A-Za-z]+"></div>
                <div class="input-group"><label for="chacra" class="label">Chacra</label><input type="number" id="chacra" class="input" min="0" max="999"></div>
                <div class="input-group"><label for="letraChacra" class="label">L. CH.</label><input type="text" id="letraChacra" class="input" maxlength="2" pattern="[A-Za-z]+"></div>
                <div class="input-group"><label for="quinta" class="label">Quinta</label><input type="number" id="quinta" class="input" min="0" max="999"></div>
                <div class="input-group"><label for="letraQuinta" class="label">L. Qt.</label><input type="text" id="letraQuinta" class="input" maxlength="2" pattern="[A-Za-z]+"></div>
                <div class="input-group"><label for="fraccion" class="label">Fracción</label><input type="number" id="fraccion" class="input" min="0" max="999"></div>
                <div class="input-group"><label for="letraFraccion" class="label">L. Fr.</label><input type="text" id="letraFraccion" class="input" maxlength="2" pattern="[A-Za-z]+"></div>
                <div class="input-group"><label for="manzana" class="label">Manzana</label><input type="number" id="manzana" class="input" min="0" max="999"></div>
                <div class="input-group"><label for="letraManzana" class="label">L. Mz.</label><input type="text" id="letraManzana" class="input" maxlength="2" pattern="[A-Za-z]+"></div>
                <div class="input-group"><label for="parcela" class="label">Parcela</label><input type="number" id="parcela" class="input" min="0" max="999"></div>
                <div class="input-group"><label for="letraParcela" class="label">L. Pc.</label><input type="text" id="letraParcela" class="input" maxlength="2" pattern="[A-Za-z]+"></div>
                <div class="input-group"><label for="partidaProvincial" class="label">Partida Provincial</label><input type="number" id="partidaProvincial" class="input"></div>
                <div class="input-group"><label for="partidaMunicipal" class="label">Partida Municipal</label><input type="number" id="partidaMunicipal" class="input"></div>
              </div>
            </div>

            <!-- Actions -->
            <div class="mt-6 flex flex-wrap items-center gap-3">
              <button id="btnGuardarExpediente" class="btn-secondary">Guardar expediente</button>
              <button id="btnGenerar" class="btn-primary" disabled>Generar código</button>
              <span id="msgCarga" class="text-sm"></span>
            </div>
          </div>
        </section>

        <!-- Panel BÚSQUEDA -->
        <section id="panelBusqueda" class="card hidden">
          <div class="card-head">
            <h2 class="title">BÚSQUEDA <span class="sub">· por ID o escaneo</span></h2>
          </div>
          <div class="card-body space-y-6">
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4">
              <div><label class="label" for="bCodigo">Código</label><input id="bCodigo" type="text" inputmode="numeric" class="input" maxlength="4"></div>
              <div><label class="label" for="bNumero">Número</label><input id="bNumero" type="text" inputmode="numeric" class="input" maxlength="6"></div>
              <div><label class="label" for="bLetra">Letra</label><input id="bLetra" type="text" class="input" maxlength="1"></div>
              <div><label class="label" for="bAnio">Año</label><input id="bAnio" type="text" inputmode="numeric" class="input" maxlength="4"></div>
              <div class="flex items-end gap-2"><button id="btnBuscar" class="btn-primary w-full">Buscar</button></div>
            </div>

            <div class="flex items-center gap-3">
              <button id="btnEscanear" class="btn-secondary">Escanear</button>
              <button id="btnBusqAvanzada" class="btn-secondary">Búsqueda avanzada</button>
              <input id="usbScanInput" type="text" class="sr-only" aria-hidden="true" />
              <span class="text-xs text-gray-500 dark:text-gray-400">Tip: lector USB escribe aquí en segundo plano; presioná el gatillo y listo.</span>
            </div>

            <!-- Advanced search form -->
            <div id="busqAvanzada" class="hidden space-y-4">
              <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="input-group"><label for="aCircunscripcion" class="label">Circunscripción</label><input type="number" id="aCircunscripcion" class="input" min="1" max="7"></div>
                <div class="input-group"><label for="aSeccion" class="label">Sección</label><input type="text" id="aSeccion" class="input" maxlength="2" pattern="[A-Za-z]+"></div>
                <div class="input-group"><label for="aChacra" class="label">Chacra</label><input type="number" id="aChacra" class="input" min="0" max="999"></div>
                <div class="input-group"><label for="aLetraChacra" class="label">L. CH.</label><input type="text" id="aLetraChacra" class="input" maxlength="2"></div>
                <div class="input-group"><label for="aQuinta" class="label">Quinta</label><input type="number" id="aQuinta" class="input" min="0" max="999"></div>
                <div class="input-group"><label for="aLetraQuinta" class="label">L. Qt.</label><input type="text" id="aLetraQuinta" class="input" maxlength="2"></div>
                <div class="input-group"><label for="aFraccion" class="label">Fracción</label><input type="number" id="aFraccion" class="input" min="0" max="999"></div>
                <div class="input-group"><label for="aLetraFraccion" class="label">L. Fr.</label><input type="text" id="aLetraFraccion" class="input" maxlength="2"></div>
                <div class="input-group"><label for="aManzana" class="label">Manzana</label><input type="number" id="aManzana" class="input" min="0" max="999"></div>
                <div class="input-group"><label for="aLetraManzana" class="label">L. Mz.</label><input type="text" id="aLetraManzana" class="input" maxlength="2"></div>
                <div class="input-group"><label for="aParcela" class="label">Parcela</label><input type="number" id="aParcela" class="input" min="0" max="999"></div>
                <div class="input-group"><label for="aLetraParcela" class="label">L. Pc.</label><input type="text" id="aLetraParcela" class="input" maxlength="2"></div>
                <div class="input-group"><label for="aPartidaProvincial" class="label">Partida Provincial</label><input type="number" id="aPartidaProvincial" class="input"></div>
                <div class="input-group"><label for="aPartidaMunicipal" class="label">Partida Municipal</label><input type="number" id="aPartidaMunicipal" class="input"></div>
              </div>
              <div class="flex items-center gap-2">
                <button id="btnBuscarAvanzado" class="btn-primary">Buscar con filtros</button>
                <button id="btnLimpiarFiltros" class="btn-secondary">Limpiar filtros</button>
                <p class="text-xs text-gray-500 dark:text-gray-400">Regla: con <b>Partida Municipal</b> o <b>Provincial</b> alcanza con uno; para el resto, mínimo 2 campos.</p>
              </div>
            </div>

            <div id="resultados" class="mt-2">
              <div class="border rounded-xl p-4 text-sm text-gray-500 dark:text-gray-400">Sin resultados aún.</div>
            </div>
          </div>
        </section>
      </main>
    </div>
  </div>

  <!-- Modal: Generador/Preview de Código -->
  <div id="modalCodigo" class="modal hidden">
    <div class="modal-backdrop"></div>
    <div class="modal-card">
      <div class="modal-head">
        <h3 class="text-lg font-medium">Etiqueta de expediente</h3>
        <button class="modal-close" data-close-modal="modalCodigo" aria-label="Cerrar">✕</button>
      </div>
      <div class="p-5 space-y-4">
        <div class="text-center">
          <div id="legendText" class="text-xs text-gray-500 dark:text-gray-400 mb-1">Coordinación General de Programa de Tierras y Regularización Dominial</div>
          <canvas id="barcodeCanvas" class="mx-auto"></canvas>
          <div id="barcodeHuman" class="mt-1 font-medium tracking-wide"></div>
        </div>
        <div class="flex flex-wrap items-center justify-end gap-2">
          <button id="btnCopiarId" class="btn-secondary text-sm">Copiar ID</button>
          <a id="btnDescargarPng" download class="btn-secondary text-sm" href="#">Descargar PNG</a>
          <button id="btnImprimirPdf" class="btn-primary text-sm">Imprimir</button>
          <button class="btn-secondary text-sm" data-close-modal="modalCodigo">Cerrar</button>
        </div>
        <div id="msgModal" class="text-sm"></div>
      </div>
    </div>
  </div>

  <!-- Modal: Escaneo con Cámara -->
  <div id="modalEscaner" class="modal hidden">
    <div class="modal-backdrop"></div>
    <div class="modal-card modal-wide">
      <div class="modal-head">
        <h3 class="text-lg font-medium">Escanear código de barras</h3>
        <button class="modal-close" data-close-modal="modalEscaner" aria-label="Cerrar">✕</button>
      </div>
      <div class="p-5 space-y-4">
        <div class="flex flex-wrap items-center gap-3">
          <label class="text-sm">Cámara:</label>
          <select id="selCamaras" class="input input--sm"></select>
          <button id="btnLinterna" class="btn-secondary text-sm disabled:opacity-50" disabled>Linterna</button>
        </div>

        <div class="relative rounded-xl overflow-hidden bg-black scan-overlay">
          <video id="video" class="w-full h-[55vh] object-cover"></video>
        </div>

        <div class="text-xs text-gray-500 dark:text-gray-400">
          Alineá el código dentro del marco. En algunos dispositivos la linterna puede no estar disponible.
        </div>

        <div class="flex items-center justify-end gap-2">
          <button class="btn-secondary text-sm" data-close-modal="modalEscaner">Cerrar</button>
        </div>
        <div id="msgEscaner" class="text-sm"></div>
      </div>
    </div>
  </div>

  <!-- Modal: Configuración -->
  <div id="modalConfig" class="modal hidden">
    <div class="modal-backdrop"></div>
    <div class="modal-card">
      <div class="modal-head">
        <h3 class="text-lg font-medium">Configuración</h3>
        <button class="modal-close" data-close-modal="modalConfig" aria-label="Cerrar">✕</button>
      </div>
      <div class="p-5 space-y-4 text-sm">
        <div class="space-y-2">
          <label for="confApodo" class="label">Apodo para registrar movimientos</label>
          <input id="confApodo" type="text" class="input" placeholder="12345 Apellido" />
          <p class="hint">Se mostrará como autor en tus nuevos movimientos.</p>
          <div class="flex items-center gap-2"><button id="btnGuardarApodo" class="btn-primary">Guardar apodo</button><span id="msgApodo" class="text-sm"></span></div>
        </div>
        <div class="space-y-2">
          <label class="label">Tema</label>
          <div class="flex flex-wrap gap-2">
            <button class="btn-secondary" data-theme="system">Sistema</button>
            <button class="btn-secondary" data-theme="light">Claro</button>
            <button class="btn-secondary" data-theme="dark">Oscuro</button>
          </div>
          <p class="hint">Por defecto sigue la preferencia del sistema. Podés forzarlo aquí.</p>
        </div>
        <div class="flex items-center justify-end gap-2 pt-2 border-t border-gray-200 dark:border-gray-800">
          <button class="btn-secondary" data-close-modal="modalConfig">Cerrar</button>
        </div>
      </div>
    </div>
  </div>

  <script type="module" src="./app.js"></script>
</body>
</html>
