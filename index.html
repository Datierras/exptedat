<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Gestión de Expedientes</title>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, addDoc, query, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // 🔥 Configuración de Firebase
    const firebaseConfig = {
      apiKey: "TU_API_KEY",
      authDomain: "TU_PROJECT.firebaseapp.com",
      projectId: "TU_PROJECT",
      storageBucket: "TU_PROJECT.appspot.com",
      messagingSenderId: "XXXXXX",
      appId: "1:XXXX:web:XXXX"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();
    const db = getFirestore(app);

    let allMovements = []; // 📦 Expedientes en memoria

    // 🔐 Login con Google
    window.loginConGoogle = async () => {
      try {
        await signInWithPopup(auth, provider);
        document.getElementById("login-section").style.display = "none";
        document.getElementById("loading").style.display = "block";
      } catch (error) {
        console.error("Error en login:", error);
      }
    };

    // 📡 Escucha de Firestore en tiempo real
    const q = query(collection(db, 'expedientes'));
    onSnapshot(q,
      (querySnapshot) => {
        const movimientos = [];
        querySnapshot.forEach(doc => movimientos.push(doc.data()));
        allMovements = movimientos;

        document.getElementById("loading").style.display = "none";
        document.getElementById("app-content").style.display = "flex";
      },
      (error) => {
        console.error("Error al obtener datos:", error);
      }
    );

    // 📤 Guardar expediente
    window.guardarExpediente = async () => {
      const codigo = document.getElementById("codigo").value.trim();
      const numero = document.getElementById("numero").value.trim();
      const letra = document.getElementById("letra").value.trim();
      const anio = document.getElementById("anio").value.trim();
      const cuerpo = document.getElementById("cuerpo").value.trim();

      if (!codigo || !numero || !letra || !anio) {
        alert("Completa todos los campos obligatorios");
        return;
      }

      try {
        await addDoc(collection(db, "expedientes"), {
          codigo, numero, letra, anio, cuerpo
        });
        alert("Expediente guardado ✅");
        document.getElementById("form-expediente").reset();
      } catch (e) {
        console.error("Error al guardar:", e);
      }
    };

    // 🔎 Buscar expediente
    window.buscarExpediente = () => {
      const termino = document.getElementById("buscar").value.trim().toLowerCase();
      const resultados = allMovements.filter(exp =>
        exp.codigo.toLowerCase().includes(termino) ||
        exp.numero.toLowerCase().includes(termino) ||
        exp.letra.toLowerCase().includes(termino) ||
        exp.anio.toLowerCase().includes(termino) ||
        (exp.cuerpo && exp.cuerpo.toLowerCase().includes(termino))
      );
      renderResults(resultados);
    };

    // 🧹 Limpiar resultados
    window.limpiarResultados = () => {
      document.getElementById("buscar").value = "";
      document.getElementById("resultados").innerHTML = "";
    };

    // 📜 Renderizar resultados
    function renderResults(lista) {
      const container = document.getElementById("resultados");
      container.innerHTML = "";

      if (lista.length === 0) {
        container.innerHTML = "<p>No se encontraron expedientes.</p>";
        return;
      }

      lista.forEach(exp => {
        const div = document.createElement("div");
        div.classList.add("resultado");

        div.innerHTML = `
          <p><strong>Expediente:</strong> ${exp.codigo}-${exp.numero}-${exp.letra}-${exp.anio}</p>
          ${exp.cuerpo ? `<p><strong>Cuerpo:</strong> ${exp.cuerpo}</p>` : ""}
        `;

        container.appendChild(div);
      });
    }
  </script>

  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    #app-content { display: none; gap: 30px; }
    .col { flex: 1; }
    .resultado { border: 1px solid #ccc; padding: 10px; margin: 10px 0; border-radius: 5px; }
  </style>
</head>
<body>
  <!-- Login -->
  <div id="login-section">
    <button onclick="loginConGoogle()">Iniciar sesión con Google</button>
  </div>

  <!-- Cargando -->
  <div id="loading" style="display:none;">Conectando...</div>

  <!-- App -->
  <div id="app-content">
    <div class="col">
      <h2>Cargar Expediente</h2>
      <form id="form-expediente" onsubmit="event.preventDefault(); guardarExpediente();">
        <input id="codigo" placeholder="Código" required><br>
        <input id="numero" placeholder="Número" required><br>
        <input id="letra" placeholder="Letra" required><br>
        <input id="anio" placeholder="Año" required><br>
        <input id="cuerpo" placeholder="Cuerpo"><br>
        <button type="submit">Guardar</button>
      </form>
    </div>

    <div class="col">
      <h2>Buscar Expediente</h2>
      <input id="buscar" placeholder="Buscar...">
      <button onclick="buscarExpediente()">Buscar</button>
      <button onclick="limpiarResultados()">Limpiar resultados</button>
      <div id="resultados"></div>
    </div>
  </div>
</body>
</html>
