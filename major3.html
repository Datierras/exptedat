<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Control de Expedientes</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js"></script>
</head>

<body class="bg-gray-100 flex flex-col items-center min-h-screen p-4">

  <div id="main-app-wrapper"
    class="container bg-white rounded-xl shadow-lg flex flex-col relative p-8 gap-8 mt-6">

    <!-- Login -->
    <div id="login-container" class="w-full flex flex-col items-center">
      <h1 class="text-3xl font-bold mb-1 text-gray-800 text-center">SISTEMA DE EXPEDIENTES</h1>
      <form id="loginForm" class="w-full max-w-sm">
        <div class="input-group mb-4">
          <label for="username">Usuario (Email)</label>
          <input type="text" id="username" class="w-full mt-1" required autocomplete="email">
        </div>
        <div class="input-group mb-6">
          <label for="password">Contraseña</label>
          <input type="password" id="password" class="w-full mt-1" required autocomplete="current-password">
        </div>
        <button type="submit" id="loginBtn" class="btn btn-primary w-full">Iniciar sesión</button>
      </form>
    </div>

    <!-- App -->
    <div id="app-content-wrapper" class="w-full" style="display: none;">
      <h1 class="text-2xl font-bold mb-6 text-center text-gray-800">Control de Expedientes</h1>

      <div id="app-content" class="flex flex-col md:flex-row gap-8 w-full">
        <!-- Cargar Movimiento -->
        <div class="flex-1">
          <h2 class="text-2xl font-bold mb-6 text-center text-gray-800">Cargar Movimiento</h2>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label for="codigo">Código *</label>
              <input type="number" id="codigo" class="w-full mt-1" required>
            </div>
            <div>
              <label for="numero">Número *</label>
              <input type="number" id="numero" class="w-full mt-1" required>
            </div>
            <div>
              <label for="letra">Letra *</label>
              <input type="text" id="letra" class="w-full mt-1" maxlength="1" required>
            </div>
            <div>
              <label for="anio">Año *</label>
              <input type="number" id="anio" class="w-full mt-1" required>
            </div>
          </div>

          <!-- Botón de generar código -->
          <div class="mt-4">
            <button id="generateBarcodeBtn" class="btn btn-secondary w-full">
              Generar Código de Barras
            </button>
            <div id="barcodeContainer" class="mt-4 text-center hidden">
              <svg id="barcode"></svg>
              <button id="printBarcodeBtn" class="btn btn-primary mt-2">Imprimir Código</button>
            </div>
          </div>
        </div>

        <!-- Buscar Expediente -->
        <div class="flex-1">
          <h2 class="text-2xl font-bold mb-6 text-center text-gray-800">Buscar Expediente</h2>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label for="searchCodigo">Código</label>
              <input type="number" id="searchCodigo" class="w-full mt-1">
            </div>
            <div>
              <label for="searchNumero">Número</label>
              <input type="number" id="searchNumero" class="w-full mt-1">
            </div>
            <div>
              <label for="searchLetra">Letra</label>
              <input type="text" id="searchLetra" class="w-full mt-1">
            </div>
            <div>
              <label for="searchAnio">Año</label>
              <input type="number" id="searchAnio" class="w-full mt-1">
            </div>
          </div>

          <div class="input-group mt-4">
            <label for="scanBarcode">Escanear Código de Barras</label>
            <input type="text" id="scanBarcode" class="w-full mt-1" placeholder="Escaneá aquí el código...">
          </div>

          <div class="mt-6">
            <h3 class="text-lg font-semibold mb-3 text-gray-700">Resultados</h3>
            <div id="searchResults" class="overflow-y-auto max-h-96 border rounded p-2">
              <p class="text-gray-500 text-center">No se encontraron movimientos.</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import {
      getAuth,
      signInWithEmailAndPassword,
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
    import {
      getFirestore,
      doc,
      getDoc,
      setDoc,
      collection,
      query,
      where,
      getDocs
    } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAHXCfXoJK1p_naZf5v0_cAa6cphX1e1E8",
      authDomain: "exptcoord.firebaseapp.com",
      projectId: "exptcoord",
      storageBucket: "exptcoord.firebasestorage.app",
      messagingSenderId: "416639039117",
      appId: "1:416639039117:web:d9422f6d853a760a3014c4",
      measurementId: "G-94PRRLFZV4"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const loginContainer = document.getElementById("login-container");
    const appContentWrapper = document.getElementById("app-content-wrapper");
    const loginForm = document.getElementById("loginForm");
    const usernameInput = document.getElementById("username");
    const passwordInput = document.getElementById("password");

    const generateBarcodeBtn = document.getElementById("generateBarcodeBtn");
    const barcodeContainer = document.getElementById("barcodeContainer");
    const barcodeSVG = document.getElementById("barcode");
    const printBarcodeBtn = document.getElementById("printBarcodeBtn");
    const scanBarcodeInput = document.getElementById("scanBarcode");
    const searchResultsContainer = document.getElementById("searchResults");

    loginForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      try {
        await signInWithEmailAndPassword(auth, usernameInput.value.trim(), passwordInput.value.trim());
      } catch {
        alert("Error de login");
      }
    });

    onAuthStateChanged(auth, (user) => {
      if (user) {
        loginContainer.style.display = "none";
        appContentWrapper.style.display = "block";
      } else {
        loginContainer.style.display = "block";
        appContentWrapper.style.display = "none";
      }
    });

    generateBarcodeBtn.addEventListener("click", async () => {
      const codigo = document.getElementById("codigo").value.trim();
      const numero = document.getElementById("numero").value.trim();
      const letra = document.getElementById("letra").value.trim().toUpperCase();
      const anio = document.getElementById("anio").value.trim();

      if (!codigo || !numero || !letra || !anio) {
        alert("Completa los datos del expediente.");
        return;
      }

      const expedienteId = `${codigo}-${numero}-${letra}-${anio}`;
      const ref = doc(db, "barcodes", expedienteId);
      const snap = await getDoc(ref);

      if (!snap.exists()) {
        await setDoc(ref, { expediente: expedienteId });
      }

      JsBarcode("#barcode", expedienteId, {
        format: "CODE128",
        width: 2,
        height: 50,
        displayValue: true
      });

      barcodeContainer.classList.remove("hidden");
    });

    printBarcodeBtn.addEventListener("click", () => {
      const w = window.open("");
      w.document.write("<html><head><title>Imprimir Código</title></head><body>");
      w.document.write(barcodeSVG.outerHTML);
      w.document.write("</body></html>");
      w.document.close();
      w.print();
    });

    async function buscarMovimientos(expedienteId) {
      const [codigo, numero, letra, anio] = expedienteId.split("-");
      const q = query(
        collection(db, "movimientos"),
        where("codigo", "==", codigo),
        where("numero", "==", numero),
        where("letra", "==", letra),
        where("anio", "==", anio)
      );

      const snap = await getDocs(q);
      if (snap.empty) {
        searchResultsContainer.innerHTML = `<p class="text-gray-500 text-center">No se encontraron movimientos.</p>`;
        return;
      }

      let html = `<table class="min-w-full divide-y divide-gray-200">
        <thead><tr>
          <th class="px-4 py-2">Expediente</th>
          <th class="px-4 py-2">Oficina</th>
          <th class="px-4 py-2">Tipo</th>
          <th class="px-4 py-2">Fecha</th>
        </tr></thead><tbody>`;
      snap.forEach(doc => {
        const mov = doc.data();
        html += `<tr class="border-t">
          <td class="px-4 py-2">${mov.codigo}-${mov.numero}-${mov.letra}-${mov.anio}</td>
          <td class="px-4 py-2">${mov.oficina || '-'}</td>
          <td class="px-4 py-2">${mov.tipo || '-'}</td>
          <td class="px-4 py-2">${mov.fecha || '-'}</td>
        </tr>`;
      });
      html += `</tbody></table>`;
      searchResultsContainer.innerHTML = html;
    }

    scanBarcodeInput.addEventListener("keypress", async (e) => {
      if (e.key === "Enter") {
        const value = scanBarcodeInput.value.trim();
        if (value) {
          const partes = value.split("-");
          if (partes.length === 4) {
            document.getElementById("searchCodigo").value = partes[0];
            document.getElementById("searchNumero").value = partes[1];
            document.getElementById("searchLetra").value = partes[2];
            document.getElementById("searchAnio").value = partes[3];
            await buscarMovimientos(value);
          }
        }
      }
    });
  </script>
</body>

</html>
