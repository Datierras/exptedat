<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Control de Expedientes</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.0/dist/JsBarcode.all.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; color: #1f2937; }
        .container { max-width: 900px; padding: 2rem; }
        .input-group label { font-weight: 500; }
        .input-group input, .input-group textarea { padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.5rem; width: 100%; transition: all 0.2s; }
        .input-group input:focus, .input-group textarea:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5); }
        .radio-label { display: flex; align-items: center; gap: 0.5rem; cursor: pointer; user-select: none; }
        .radio-label input[type="radio"] { accent-color: #3b82f6; }
        .btn { padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: 600; transition: background-color 0.2s; }
        .btn-disabled { opacity: 0.6; cursor: not-allowed; }
        .btn-primary { background-color: #3b82f6; color: white; }
        .btn-primary:hover:not(.btn-disabled) { background-color: #2563eb; }
        .btn-secondary { background-color: #e5e7eb; color: #1f2937; }
        .btn-secondary:hover:not(.btn-disabled) { background-color: #d1d5db; }
        .message-box { padding: 1rem; border-radius: 0.5rem; margin-top: 1rem; font-weight: 500; display: none; }
        .message-success { background-color: #dcfce7; color: #166534; }
        .message-error { background-color: #fee2e2; color: #991b1b; }
        .results-table th, .results-table td { padding: 0.75rem; text-align: left; }
        .results-table th { font-weight: 600; border-bottom: 2px solid #e5e7eb; }
        .results-table tr:nth-child(even) { background-color: #f9fafb; }
        .footer { margin-top: 2rem; font-size: 0.75rem; color: #6b7280; text-align: center; }
        /* Modales arrancan ocultos */
        #barcodeModal, #scannerModal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 50; }
        #barcodeModalContent, #scannerModalContent { background-color: white; padding: 2rem; border-radius: 0.5rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); text-align: center; max-width: 90%; position: relative; }
        @media print { body * { visibility: hidden; } #barcodeModalContent, #barcodeModalContent * { visibility: visible; } #barcodeModalContent { position: absolute; left: 0; top: 0; width: 100%; } }
    </style>
</head>

<body class="bg-gray-100 flex flex-col items-center min-h-screen p-4">

    <!-- LOGIN -->
    <div id="login-section" class="flex flex-col items-center justify-center min-h-screen w-full p-4">
        <div class="bg-white p-8 rounded-lg shadow-lg max-w-sm w-full">
            <h2 class="text-2xl font-bold text-center text-blue-800 mb-6">Iniciar Sesión</h2>
            <form id="loginForm" class="flex flex-col gap-4">
                <div class="input-group">
                    <label for="email">Correo Electrónico</label>
                    <input type="email" id="email" class="mt-1" required />
                </div>
                <div class="input-group">
                    <label for="password">Contraseña</label>
                    <input type="password" id="password" class="mt-1" required />
                </div>
                <button type="submit" class="btn btn-primary w-full">Ingresar</button>
            </form>
        </div>
    </div>

    <!-- APP -->
    <div id="main-app-wrapper" class="container bg-white rounded-xl shadow-lg flex flex-col relative p-8 gap-8 mt-6 hidden">
        <h1 class="text-3xl font-bold text-center text-blue-800">Control de Expedientes</h1>

        <!-- Formulario -->
        <form id="expedienteForm" class="flex flex-col gap-6">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div class="input-group"><label for="codigo">Código</label><input type="number" id="codigo" required /></div>
                <div class="input-group"><label for="numero">Número</label><input type="number" id="numero" required /></div>
                <div class="input-group"><label for="letra">Letra</label><input type="text" id="letra" maxlength="1" required /></div>
                <div class="input-group"><label for="anio">Año</label><input type="number" id="anio" required /></div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="input-group"><label for="ubicacion">Ubicación</label><input type="text" id="ubicacion" required /></div>
                <div class="input-group"><label for="estado">Estado</label><input type="text" id="estado" required /></div>
            </div>
            <div class="flex flex-col sm:flex-row gap-4">
                <button type="submit" id="saveBtn" class="btn btn-primary w-full">Guardar</button>
            </div>
            <div class="flex flex-col sm:flex-row gap-4">
                <button type="button" id="generateBarcodeBtn" class="btn btn-primary w-full">Generar Código</button>
            </div>
            <div id="saveMessage" class="message-box message-success"></div>
        </form>

        <!-- Buscar -->
        <h2 class="text-xl font-bold text-gray-700">Buscar expediente</h2>
        <div class="flex flex-col sm:flex-row gap-4">
            <button type="button" id="searchBtn" class="btn btn-primary w-full">Buscar</button>
            <button type="button" id="clearBtn" class="btn btn-secondary w-full">Limpiar</button>
            <button type="button" id="scanBarcodeBtn" class="btn btn-primary w-full">Escanear Código</button>
        </div>
        <div id="searchResults" class="rounded-lg shadow overflow-hidden">
            <table class="w-full results-table bg-white">
                <thead><tr><th>Expediente</th><th>Ubicación</th><th>Estado</th><th>Fecha</th><th>Usuario</th></tr></thead>
                <tbody id="resultsBody"></tbody>
            </table>
        </div>
        <div id="searchMessage" class="message-box message-error hidden"></div>

        <footer class="footer"><p>&copy; 2025. Todos los derechos reservados.</p></footer>
    </div>

    <!-- Modal código -->
    <div id="barcodeModal" class="hidden">
        <div id="barcodeModalContent" class="flex flex-col items-center gap-4">
            <h3 class="text-lg font-bold">Código de Barras</h3>
            <svg id="barcodeSvg" class="w-full h-auto"></svg>
            <p id="barcodeDataText" class="text-sm text-gray-600"></p>
            <div class="flex gap-4">
                <button id="printBarcodeBtn" class="btn btn-primary">Imprimir</button>
                <button id="closeBarcodeModalBtn" class="btn btn-secondary">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- Modal escáner -->
    <div id="scannerModal" class="hidden">
        <div id="scannerModalContent" class="flex flex-col items-center gap-4">
            <h3 class="text-lg font-bold">Escanear Código de Barras</h3>
            <div id="reader" style="width: 300px; height: 300px;"></div>
            <p id="scannerMessage" class="text-sm text-gray-600"></p>
            <button id="closeScannerModalBtn" class="btn btn-secondary">Cerrar Escáner</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // 🔑 Tu configuración real de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAHXCfXoJK1p_naZf5v0_cAa6cphX1e1E8",
            authDomain: "exptcoord.firebaseapp.com",
            projectId: "exptcoord",
            storageBucket: "exptcoord.firebasestorage.app",
            messagingSenderId: "416639039117",
            appId: "1:416639039117:web:d9422f6d853a760a3014c4",
            measurementId: "G-94PRRLFZV4"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const loginSection=document.getElementById('login-section'), mainAppWrapper=document.getElementById('main-app-wrapper'), loginForm=document.getElementById('loginForm');
        const resultsBody=document.getElementById('resultsBody'), searchMessage=document.getElementById('searchMessage');

        // Login
        loginForm.addEventListener('submit',async(e)=>{ e.preventDefault(); try{ await signInWithEmailAndPassword(auth, loginForm.email.value, loginForm.password.value);}catch(err){alert(`Error al iniciar sesión: ${err.message}`);} });
        onAuthStateChanged(auth,(user)=>{ if(user){ loginSection.classList.add('hidden'); mainAppWrapper.classList.remove('hidden'); } else { loginSection.classList.remove('hidden'); mainAppWrapper.classList.add('hidden'); } });

        // Buscar
        async function filterAndRenderResults(barcodeScanned=null){
            resultsBody.innerHTML=''; searchMessage.style.display='none';
            let expedientesQuery=collection(db,'expedientes');
            if(barcodeScanned){ expedientesQuery=query(expedientesQuery,where('barcode','==',barcodeScanned)); }
            try{ const qs=await getDocs(expedientesQuery); if(qs.empty){ searchMessage.style.display='block'; searchMessage.textContent='No se encontraron expedientes.'; return;}
                qs.forEach((doc)=>{const d=doc.data(); resultsBody.innerHTML+=`<tr><td>${d.codigo}-${d.numero}-${d.letra}-${d.anio}</td><td>${d.ubicacion||''}</td><td>${d.estado||''}</td><td>${d.fecha||''}</td><td>${d.userName||''}</td></tr>`;});
            }catch(err){ console.error(err);}
        }

        // ==== Modales ====
        const barcodeModal=document.getElementById('barcodeModal'), closeBarcodeModalBtn=document.getElementById('closeBarcodeModalBtn');
        const generateBarcodeBtn=document.getElementById('generateBarcodeBtn'), barcodeSvg=document.getElementById('barcodeSvg'), barcodeDataText=document.getElementById('barcodeDataText');
        generateBarcodeBtn.addEventListener('click',()=>{ let codigo=document.getElementById('codigo').value, numero=document.getElementById('numero').value, letra=document.getElementById('letra').value.toUpperCase(), anio=document.getElementById('anio').value;
            if(!codigo||!numero||!letra||!anio){ alert("Completa Código, Número, Letra y Año"); return;}
            let val=`${codigo}-${numero}-${letra}-${anio}`; JsBarcode(barcodeSvg,val,{format:"CODE128"}); barcodeDataText.textContent=val; barcodeModal.style.display="flex"; });
        closeBarcodeModalBtn.addEventListener('click',()=>{ barcodeModal.style.display="none"; });

        const scanBarcodeBtn=document.getElementById('scanBarcodeBtn'), scannerModal=document.getElementById('scannerModal'), closeScannerModalBtn=document.getElementById('closeScannerModalBtn'), scannerMessage=document.getElementById('scannerMessage');
        let html5QrCode=null;
        scanBarcodeBtn.addEventListener('click',()=>{ scannerModal.style.display="flex"; if(!html5QrCode){ html5QrCode=new Html5Qrcode("reader"); }
            html5QrCode.start({facingMode:"environment"},{fps:10,qrbox:250},(decodedText)=>{ scannerMessage.textContent=`Detectado: ${decodedText}`; filterAndRenderResults(decodedText); closeScanner(); }); });
        function closeScanner(){ if(html5QrCode){ html5QrCode.stop().then(()=>{ scannerModal.style.display="none"; scannerMessage.textContent=""; }); } else { scannerModal.style.display="none"; } }
        closeScannerModalBtn.addEventListener('click',closeScanner);

        // ==== Cerrar modales con ESC ====
        document.addEventListener("keydown",(e)=>{ if(e.key==="Escape"){ barcodeModal.style.display="none"; closeScanner(); }});
    </script>
</body>
</html>
