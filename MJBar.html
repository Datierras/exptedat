<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Control de Expedientes</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.0/dist/JsBarcode.all.min.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #1f2937;
        }

        .container {
            max-width: 900px;
            padding: 2rem;
        }

        .input-group label {
            font-weight: 500;
        }

        .input-group input[type="text"],
        .input-group input[type="password"],
        .input-group input[type="number"],
        .input-group textarea {
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            width: 100%;
            transition: all 0.2s;
        }

        .input-group input[type="text"]:focus,
        .input-group input[type="password"]:focus,
        .input-group input[type="number"]:focus,
        .input-group textarea:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5);
        }

        .radio-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            user-select: none;
        }

        .radio-label input[type="radio"] {
            accent-color: #3b82f6;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: background-color 0.2s;
        }

        .btn-disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-primary {
            background-color: #3b82f6;
            color: white;
        }

        .btn-primary:hover:not(.btn-disabled) {
            background-color: #2563eb;
        }

        .btn-secondary {
            background-color: #e5e7eb;
            color: #1f2937;
        }

        .btn-secondary:hover:not(.btn-disabled) {
            background-color: #d1d5db;
        }

        .message-box {
            padding: 1rem;
            border-radius: 0.5rem;
            margin-top: 1rem;
            font-weight: 500;
            display: none;
        }

        .message-success {
            background-color: #dcfce7;
            color: #166534;
        }

        .message-error {
            background-color: #fee2e2;
            color: #991b1b;
        }

        .results-table th,
        .results-table td {
            padding: 0.75rem;
            text-align: left;
        }

        .results-table th {
            font-weight: 600;
            border-bottom: 2px solid #e5e7eb;
        }

        .results-table tr:nth-child(even) {
            background-color: #f9fafb;
        }

        .no-wrap {
            white-space: nowrap;
        }

        #searchResults {
            overflow-x: auto;
        }

        /* Estilos para el menú de configuración */
        .settings-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            padding: 0.5rem;
            border-radius: 50%;
            background-color: #e5e7eb;
            transition: background-color 0.2s;
        }

        .settings-btn:hover {
            background-color: #d1d5db;
        }

        .settings-dropdown {
            position: absolute;
            top: 4rem;
            right: 1rem;
            width: 250px;
            background-color: white;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0, 0, 0, 0.08);
            z-index: 10;
        }

        .footer {
            margin-top: 2rem;
            font-size: 0.75rem;
            color: #6b7280;
            text-align: center;
        }

        /* Estilos de la ventana modal */
        #barcodeModal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
        }

        #barcodeModalContent {
            background-color: white;
            padding: 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0, 0, 0, 0.08);
            text-align: center;
            max-width: 90%;
            position: relative;
        }
        
        @media print {
            body * {
                visibility: hidden;
            }
            #barcodeModalContent, #barcodeModalContent * {
                visibility: visible;
            }
            #barcodeModalContent {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
        }
    </style>
</head>

<body class="bg-gray-100 flex flex-col items-center min-h-screen p-4">

    <div id="main-app-wrapper" class="container bg-white rounded-xl shadow-lg flex flex-col relative p-8 gap-8 mt-6">

        <button id="settingsBtn" class="settings-btn" style="display: none;">
            <svg class="w-6 h-6 text-gray-500" fill="currentColor" viewBox="0 0 20 20"
                xmlns="http://www.w3.org/2000/svg">
                <path fill-rule="evenodd"
                    d="M11.49 4.34a.75.75 0 011.02 1.02l-1.02 1.02a.75.75 0 01-1.02-1.02l1.02-1.02zm-3.06 1.02a.75.75 0 011.02-1.02l1.02 1.02a.75.75 0 01-1.02 1.02l-1.02-1.02zm-.625 2.5a.75.75 0 01-.132.887l-1.875 1.625a.75.75 0 01-.887-.132l-1.5-1.5a.75.75 0 01.132-.887l1.875-1.625a.75.75 0 01.887.132l1.5 1.5a.75.75 0 01-.132.887zm1.125 1.5a.75.75 0 01-.75-.75h3.75a.75.75 0 010 1.5H8.75a.75.75 0 01-.75-.75zm6.5 2.25a.75.75 0 01-.132.887l-1.875 1.625a.75.75 0 01-.887-.132l-1.5-1.5a.75.75 0 01.132-.887l1.875-1.625a.75.75 0 01.887.132l1.5 1.5a.75.75 0 01-.132.887zM8.75 13.5a.75.75 0 01-.75-.75V8.5a.75.75 0 011.5 0v4.25a.75.75 0 01-.75.75z"
                    clip-rule="evenodd" />
            </svg>
        </button>
        <div id="settingsPanel" class="settings-dropdown p-4 hidden">
            <h3 class="font-bold mb-2">Configuración</h3>
            <div id="update-name-container" class="w-full">
                <p class="text-sm text-gray-600 mb-2">
                    Tu nombre actual es: <span id="current-username" class="font-semibold"></span>
                </p>
                <div class="input-group mb-4">
                    <label for="newUsername">Asignar nuevo nombre</label>
                    <input type="text" id="newUsername" class="w-full mt-1" placeholder="Ej: 12345 Apellido">
                </div>
                <button id="updateNameBtn" class="btn btn-secondary w-full mb-4">Actualizar nombre</button>
            </div>
            <button id="logoutBtn" class="btn btn-secondary w-full">Cerrar Sesión</button>
        </div>

        <h1 class="text-3xl font-bold text-center text-blue-800">Control de Expedientes</h1>

        <form id="expedienteForm" class="flex flex-col gap-6">
            <h2 class="text-xl font-bold text-gray-700">Cargar nuevo expediente</h2>

            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div class="input-group">
                    <label for="codigo">Código</label>
                    <input type="number" id="codigo" class="mt-1" placeholder="Ej: 4078" required />
                </div>
                <div class="input-group">
                    <label for="numero">Número</label>
                    <input type="number" id="numero" class="mt-1" placeholder="Ej: 255255" required />
                </div>
                <div class="input-group">
                    <label for="letra">Letra</label>
                    <input type="text" id="letra" class="mt-1 uppercase" maxlength="1" placeholder="Ej: I" required />
                </div>
                <div class="input-group">
                    <label for="anio">Año</label>
                    <input type="number" id="anio" class="mt-1" placeholder="Ej: 2025" required />
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="input-group">
                    <label for="ubicacion">Ubicación</label>
                    <input type="text" id="ubicacion" class="mt-1" placeholder="Ej: Mesa de Entradas" required />
                </div>
                <div class="input-group">
                    <label for="estado">Estado</label>
                    <input type="text" id="estado" class="mt-1" placeholder="Ej: En trámite" required />
                </div>
            </div>

            <div class="flex items-center gap-2">
                <button type="button" id="showNomenclaturaBtn" class="btn btn-secondary w-max">
                    Mostrar Nomenclatura
                </button>
            </div>
            <div id="nomenclaturaFields" class="grid grid-cols-1 md:grid-cols-3 gap-4 hidden">
                <div class="input-group">
                    <label for="circunscripcion">Circunscripción</label>
                    <input type="number" id="circunscripcion" class="mt-1" placeholder="Ej: 4078" />
                </div>
                <div class="input-group">
                    <label for="seccion">Sección</label>
                    <input type="text" id="seccion" class="mt-1" placeholder="Ej: B" />
                </div>
                <div class="input-group">
                    <label for="chacra">Chacra</label>
                    <input type="text" id="chacra" class="mt-1" placeholder="Ej: B" />
                </div>
                <div class="input-group">
                    <label for="quinta">Quinta</label>
                    <input type="text" id="quinta" class="mt-1" placeholder="Ej: B" />
                </div>
                <div class="input-group">
                    <label for="fraccion">Fracción</label>
                    <input type="text" id="fraccion" class="mt-1" placeholder="Ej: B" />
                </div>
                <div class="input-group">
                    <label for="manzana">Manzana</label>
                    <input type="text" id="manzana" class="mt-1" placeholder="Ej: B" />
                </div>
                <div class="input-group">
                    <label for="parcela">Parcela</label>
                    <input type="text" id="parcela" class="mt-1" placeholder="Ej: B" />
                </div>
                <div class="input-group">
                    <label for="subparcela">Sub-Parcela</label>
                    <input type="text" id="subparcela" class="mt-1" placeholder="Ej: B" />
                </div>
                <div class="input-group">
                    <label for="subsuelo">Subsuelo</label>
                    <input type="text" id="subsuelo" class="mt-1" placeholder="Ej: 1" />
                </div>
                <div class="input-group">
                    <label for="partidaProvincial">Partida Provincial</label>
                    <input type="number" id="partidaProvincial" class="mt-1" placeholder="Ej: 123456" />
                </div>
                <div class="input-group">
                    <label for="partidaMunicipal">Partida Municipal</label>
                    <input type="number" id="partidaMunicipal" class="mt-1" placeholder="Ej: 654321" />
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="input-group">
                    <label for="observaciones">Observaciones</label>
                    <textarea id="observaciones" class="mt-1"
                        placeholder="Observaciones sobre el expediente..."></textarea>
                </div>
                <div class="input-group">
                    <label>Tipo de Movimiento</label>
                    <div class="flex flex-col gap-2 mt-1">
                        <label class="radio-label">
                            <input type="radio" name="tipoMovimiento" value="ingreso" checked />
                            Ingreso
                        </label>
                        <label class="radio-label">
                            <input type="radio" name="tipoMovimiento" value="egreso" />
                            Egreso
                        </label>
                    </div>
                </div>
            </div>

            <div class="flex flex-col sm:flex-row gap-4">
                <button type="submit" id="saveBtn" class="btn btn-primary w-full">Guardar</button>
            </div>
            <div class="flex flex-col sm:flex-row gap-4">
                <button type="button" id="generateBarcodeBtn" class="btn btn-primary w-full">Generar Código</button>
            </div>

            <div id="saveMessage" class="message-box message-success"></div>
        </form>

        <hr class="border-gray-300" />

        <div class="flex flex-col gap-6">
            <h2 class="text-xl font-bold text-gray-700">Buscar expediente</h2>

            <div class="flex items-center gap-2">
                <button type="button" id="showAdvancedSearchBtn" class="btn btn-secondary w-max">
                    Búsqueda Avanzada
                </button>
            </div>
            <div id="advancedSearchFields" class="grid grid-cols-1 md:grid-cols-4 gap-4 hidden">
                <div class="input-group">
                    <label for="searchCodigo">Código</label>
                    <input type="number" id="searchCodigo" class="mt-1" placeholder="Código" />
                </div>
                <div class="input-group">
                    <label for="searchNumero">Número</label>
                    <input type="number" id="searchNumero" class="mt-1" placeholder="Número" />
                </div>
                <div class="input-group">
                    <label for="searchLetra">Letra</label>
                    <input type="text" id="searchLetra" class="mt-1 uppercase" placeholder="Letra" />
                </div>
                <div class="input-group">
                    <label for="searchAnio">Año</label>
                    <input type="number" id="searchAnio" class="mt-1" placeholder="Año" />
                </div>
                <div class="input-group">
                    <label for="searchUbicacion">Ubicación</label>
                    <input type="text" id="searchUbicacion" class="mt-1" placeholder="Ubicación" />
                </div>
            </div>
            <div class="flex flex-col sm:flex-row gap-4">
                <button type="button" id="searchBtn" class="btn btn-primary w-full">Buscar</button>
                <button type="button" id="clearBtn" class="btn btn-secondary w-full">Limpiar Búsqueda</button>
            </div>

            <div id="searchResults" class="rounded-lg shadow overflow-hidden">
                <table class="w-full results-table bg-white">
                    <thead>
                        <tr>
                            <th class="no-wrap">Expediente</th>
                            <th>Ubicación</th>
                            <th>Estado</th>
                            <th>Movimiento</th>
                            <th class="no-wrap">Fecha</th>
                            <th>Usuario</th>
                        </tr>
                    </thead>
                    <tbody id="resultsBody">
                        </tbody>
                </table>
            </div>

            <div id="searchMessage" class="message-box message-error hidden"></div>
        </div>

        <footer class="footer">
            <p>&copy; 2025. Todos los derechos reservados.</p>
        </footer>

    </div>

    <div id="barcodeModal" class="hidden">
        <div id="barcodeModalContent" class="flex flex-col items-center gap-4">
            <h3 class="text-lg font-bold">Código de Barras</h3>
            <svg id="barcodeSvg" class="w-full h-auto"></svg>
            <p id="barcodeDataText" class="text-sm text-gray-600"></p>
            <div class="flex gap-4">
                <button id="printBarcodeBtn" class="btn btn-primary">Imprimir</button>
                <button id="closeBarcodeModalBtn" class="btn btn-secondary">Cerrar</button>
            </div>
        </div>
    </div>

    <script type="module">
        // Importa los módulos de Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, getDocs, updateDoc, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // CONFIGURACIÓN DE FIREBASE (REEMPLAZA CON TU PROPIA CONFIGURACIÓN)
        const firebaseConfig = {
            apiKey: "TU_API_KEY",
            authDomain: "TU_AUTH_DOMAIN",
            projectId: "TU_PROJECT_ID",
            storageBucket: "TU_STORAGE_BUCKET",
            messagingSenderId: "TU_MESSAGING_SENDER_ID",
            appId: "TU_APP_ID"
        };

        // Inicializa Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Referencias a elementos del DOM
        const loginSection = document.getElementById('login-section');
        const mainAppWrapper = document.getElementById('main-app-wrapper');
        const loginForm = document.getElementById('loginForm');
        const saveMessage = document.getElementById('saveMessage');
        const searchMessage = document.getElementById('searchMessage');
        const expedienteForm = document.getElementById('expedienteForm');
        const resultsBody = document.getElementById('resultsBody');
        const showNomenclaturaBtn = document.getElementById('showNomenclaturaBtn');
        const nomenclaturaFields = document.getElementById('nomenclaturaFields');
        const showAdvancedSearchBtn = document.getElementById('showAdvancedSearchBtn');
        const advancedSearchFields = document.getElementById('advancedSearchFields');
        const settingsBtn = document.getElementById('settingsBtn');
        const settingsPanel = document.getElementById('settingsPanel');
        const logoutBtn = document.getElementById('logoutBtn');
        const newUsernameInput = document.getElementById('newUsername');
        const updateNameBtn = document.getElementById('updateNameBtn');
        const currentUsernameSpan = document.getElementById('current-username');

        // Referencias para la funcionalidad de código de barras
        const generateBarcodeBtn = document.getElementById('generateBarcodeBtn');
        const barcodeModal = document.getElementById('barcodeModal');
        const barcodeSvg = document.getElementById('barcodeSvg');
        const barcodeDataText = document.getElementById('barcodeDataText');
        const printBarcodeBtn = document.getElementById('printBarcodeBtn');
        const closeBarcodeModalBtn = document.getElementById('closeBarcodeModalBtn');

        // Variables para el usuario actual y su nombre
        let currentUserId = null;
        let currentUserName = '';

        // Manejo del estado de autenticación
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUserId = user.uid;
                const userDocRef = doc(db, 'users', currentUserId);
                const userDoc = await getDoc(userDocRef);
                if (userDoc.exists()) {
                    currentUserName = userDoc.data().name || user.email;
                    currentUsernameSpan.textContent = currentUserName;
                } else {
                    currentUserName = user.email;
                    currentUsernameSpan.textContent = currentUserName;
                    // Crea un documento de usuario si no existe
                    await setDoc(userDocRef, { name: user.email }, { merge: true });
                }
                loginSection.classList.add('hidden');
                mainAppWrapper.classList.remove('hidden');
                settingsBtn.style.display = 'block';
            } else {
                loginSection.classList.remove('hidden');
                mainAppWrapper.classList.add('hidden');
                settingsBtn.style.display = 'none';
                settingsPanel.classList.add('hidden');
            }
        });

        // Manejo de eventos
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = loginForm.email.value;
            const password = loginForm.password.value;
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                alert(`Error al iniciar sesión: ${error.message}`);
            }
        });

        expedienteForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            // Deshabilita el botón de guardar para evitar envíos múltiples
            const saveBtn = document.getElementById('saveBtn');
            saveBtn.disabled = true;
            saveBtn.classList.add('btn-disabled');

            const codigo = document.getElementById('codigo').value;
            const numero = document.getElementById('numero').value;
            const letra = document.getElementById('letra').value.toUpperCase();
            const anio = document.getElementById('anio').value;
            const ubicacion = document.getElementById('ubicacion').value;
            const estado = document.getElementById('estado').value;
            const observaciones = document.getElementById('observaciones').value;
            const tipoMovimiento = document.querySelector('input[name="tipoMovimiento"]:checked').value;
            const circunscripcion = document.getElementById('circunscripcion').value;
            const seccion = document.getElementById('seccion').value;
            const chacra = document.getElementById('chacra').value;
            const quinta = document.getElementById('quinta').value;
            const fraccion = document.getElementById('fraccion').value;
            const manzana = document.getElementById('manzana').value;
            const parcela = document.getElementById('parcela').value;
            const subparcela = document.getElementById('subparcela').value;
            const subsuelo = document.getElementById('subsuelo').value;
            const partidaProvincial = document.getElementById('partidaProvincial').value;
            const partidaMunicipal = document.getElementById('partidaMunicipal').value;

            // Busca si ya existe un expediente con el mismo código, número, letra y año
            const existingExpedienteQuery = query(
                collection(db, 'expedientes'),
                where('codigo', '==', codigo),
                where('numero', '==', numero),
                where('letra', '==', letra),
                where('anio', '==', anio)
            );

            try {
                const querySnapshot = await getDocs(existingExpedienteQuery);
                let expedienteId = null;
                let barcodeValue = null;

                if (!querySnapshot.empty) {
                    // Si el expediente ya existe, actualiza los datos y obtiene el barcode
                    const existingDoc = querySnapshot.docs[0];
                    expedienteId = existingDoc.id;
                    barcodeValue = existingDoc.data().barcode || null; // Obtiene el barcode si ya existe
                    await updateDoc(doc(db, 'expedientes', expedienteId), {
                        ubicacion,
                        estado,
                        observaciones,
                        circunscripcion: circunscripcion || null,
                        seccion: seccion || null,
                        chacra: chacra || null,
                        quinta: quinta || null,
                        fraccion: fraccion || null,
                        manzana: manzana || null,
                        parcela: parcela || null,
                        subparcela: subparcela || null,
                        subsuelo: subsuelo || null,
                        partidaProvincial: partidaProvincial || null,
                        partidaMunicipal: partidaMunicipal || null,
                        fecha: new Date().toLocaleString(),
                        oficina: "Mesa de Entradas", // Se puede cambiar dinámicamente si se necesita
                        tipo: tipoMovimiento,
                        userId: currentUserId,
                        userName: currentUserName
                    });
                    showMessage('Expediente actualizado con éxito.', 'success', saveMessage);
                } else {
                    // Si el expediente no existe, lo crea y genera un barcode único
                    barcodeValue = `${codigo}-${numero}-${letra}-${anio}`;
                    const movimiento = {
                        codigo,
                        numero,
                        letra,
                        anio,
                        ubicacion,
                        estado,
                        observaciones,
                        circunscripcion: circunscripcion || null,
                        seccion: seccion || null,
                        chacra: chacra || null,
                        quinta: quinta || null,
                        fraccion: fraccion || null,
                        manzana: manzana || null,
                        parcela: parcela || null,
                        subparcela: subparcela || null,
                        subsuelo: subsuelo || null,
                        partidaProvincial: partidaProvincial || null,
                        partidaMunicipal: partidaMunicipal || null,
                        fecha: new Date().toLocaleString(),
                        oficina: "Mesa de Entradas",
                        tipo: tipoMovimiento,
                        userId: currentUserId,
                        userName: currentUserName,
                        barcode: barcodeValue // Guarda el código de barras en el documento
                    };

                    const docRef = await addDoc(collection(db, 'expedientes'), movimiento);
                    expedienteId = docRef.id;
                    showMessage('Expediente guardado con éxito.', 'success', saveMessage);
                }

                clearInputs();
            } catch (e) {
                console.error(e);
                let msg = 'Error al guardar.';
                if (e && e.code === 'permission-denied') {
                    msg = 'Permiso denegado al escribir en "expedientes". Revisa reglas de Firestore.';
                }
                showMessage(msg + ' ' + (e.message || ''), 'error', saveMessage);
            } finally {
                // Habilita el botón de guardar de nuevo
                saveBtn.disabled = false;
                saveBtn.classList.remove('btn-disabled');
            }
        });

        // Lógica de búsqueda
        async function filterAndRenderResults() {
            resultsBody.innerHTML = '';
            searchMessage.style.display = 'none';

            const searchCodigo = document.getElementById('searchCodigo').value;
            const searchNumero = document.getElementById('searchNumero').value;
            const searchLetra = document.getElementById('searchLetra').value.toUpperCase();
            const searchAnio = document.getElementById('searchAnio').value;
            const searchUbicacion = document.getElementById('searchUbicacion').value;

            let expedientesQuery = collection(db, 'expedientes');
            let hasSearchCriteria = false;

            if (searchCodigo) {
                expedientesQuery = query(expedientesQuery, where('codigo', '==', searchCodigo));
                hasSearchCriteria = true;
            }
            if (searchNumero) {
                expedientesQuery = query(expedientesQuery, where('numero', '==', searchNumero));
                hasSearchCriteria = true;
            }
            if (searchLetra) {
                expedientesQuery = query(expedientesQuery, where('letra', '==', searchLetra));
                hasSearchCriteria = true;
            }
            if (searchAnio) {
                expedientesQuery = query(expedientesQuery, where('anio', '==', searchAnio));
                hasSearchCriteria = true;
            }
            if (searchUbicacion) {
                expedientesQuery = query(expedientesQuery, where('ubicacion', '==', searchUbicacion));
                hasSearchCriteria = true;
            }

            if (!hasSearchCriteria) {
                showMessage('Ingresa al menos un criterio de búsqueda.', 'error', searchMessage);
                return;
            }

            try {
                const querySnapshot = await getDocs(expedientesQuery);
                if (querySnapshot.empty) {
                    showMessage('No se encontraron expedientes con esos criterios.', 'error', searchMessage);
                    return;
                }

                let html = '';
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    html += `
                        <tr>
                            <td class="no-wrap">${data.codigo}-${data.numero}-${data.letra}-${data.anio}</td>
                            <td>${data.ubicacion || 'N/A'}</td>
                            <td>${data.estado || 'N/A'}</td>
                            <td>${data.tipo || 'N/A'}</td>
                            <td class="no-wrap">${data.fecha || 'N/A'}</td>
                            <td>${data.userName || 'Anónimo'}</td>
                        </tr>
                    `;
                });
                resultsBody.innerHTML = html;
            } catch (e) {
                console.error("Error al buscar documentos: ", e);
                showMessage('Error al buscar expedientes.', 'error', searchMessage);
            }
        }

        // Funciones de utilidad
        function showMessage(msg, type, element) {
            element.textContent = msg;
            element.className = `message-box ${type === 'success' ? 'message-success' : 'message-error'}`;
            element.style.display = 'block';
            setTimeout(() => {
                element.style.display = 'none';
            }, 5000);
        }

        function clearInputs() {
            expedienteForm.reset();
        }

        function clearSearchResults() {
            resultsBody.innerHTML = '';
            searchMessage.style.display = 'none';
            document.getElementById('searchCodigo').value = '';
            document.getElementById('searchNumero').value = '';
            document.getElementById('searchLetra').value = '';
            document.getElementById('searchAnio').value = '';
            document.getElementById('searchUbicacion').value = '';
        }

        // Lógica de configuración
        settingsBtn.addEventListener('click', () => {
            settingsPanel.classList.toggle('hidden');
        });

        logoutBtn.addEventListener('click', async () => {
            try {
                await signOut(auth);
            } catch (error) {
                console.error("Error al cerrar sesión:", error);
            }
        });

        updateNameBtn.addEventListener('click', async () => {
            const newName = newUsernameInput.value.trim();
            if (newName && currentUserId) {
                try {
                    await updateDoc(doc(db, 'users', currentUserId), { name: newName });
                    currentUserName = newName;
                    currentUsernameSpan.textContent = currentUserName;
                    newUsernameInput.value = '';
                    alert('Nombre de usuario actualizado con éxito.');
                } catch (e) {
                    console.error("Error al actualizar el nombre:", e);
                    alert('Error al actualizar el nombre. Revisa las reglas de Firestore.');
                }
            }
        });

        // Lógica de códigos de barras
        generateBarcodeBtn.addEventListener('click', async (e) => {
            e.preventDefault();

            const codigo = document.getElementById('codigo').value;
            const numero = document.getElementById('numero').value;
            const letra = document.getElementById('letra').value.toUpperCase();
            const anio = document.getElementById('anio').value;

            if (!codigo || !numero || !letra || !anio) {
                showMessage('Por favor, completa los campos de Código, Número, Letra y Año.', 'error', saveMessage);
                return;
            }

            // Crea la cadena de datos para el código de barras
            const barcodeData = `${codigo}-${numero}-${letra}-${anio}`;
            
            // Busca si ya existe un expediente con esos datos
            const q = query(collection(db, 'expedientes'), 
                where('codigo', '==', codigo),
                where('numero', '==', numero),
                where('letra', '==', letra),
                where('anio', '==', anio)
            );
            
            try {
                const querySnapshot = await getDocs(q);
                let expedienteDocRef = null;
                let barcodeFromDb = null;

                if (!querySnapshot.empty) {
                    expedienteDocRef = querySnapshot.docs[0].ref;
                    barcodeFromDb = querySnapshot.docs[0].data().barcode;
                }
                
                // Si el expediente no tiene un código de barras o es la primera vez que se genera, se guarda
                if (!barcodeFromDb) {
                    // Si el documento existe, lo actualizamos. Si no, esperamos a que se cree.
                    if (expedienteDocRef) {
                        await updateDoc(expedienteDocRef, { barcode: barcodeData });
                    }
                } else {
                    // Si ya existe, usamos el que está en la base de datos
                    barcodeData = barcodeFromDb; 
                }

                // Genera y muestra el código de barras en el modal
                JsBarcode("#barcodeSvg", barcodeData, {
                    format: "CODE128",
                    displayValue: true
                });
                barcodeDataText.textContent = barcodeData;
                barcodeModal.classList.remove('hidden');

            } catch (e) {
                console.error("Error al generar el código de barras:", e);
                showMessage('Error al generar el código de barras.', 'error', saveMessage);
            }
        });

        closeBarcodeModalBtn.addEventListener('click', () => {
            barcodeModal.classList.add('hidden');
        });

        printBarcodeBtn.addEventListener('click', () => {
            window.print();
        });

        // Búsqueda & Limpiar
        document.getElementById('searchBtn').addEventListener('click', filterAndRenderResults);
        document.getElementById('clearBtn').addEventListener('click', clearSearchResults);

        // Nomenclatura Button
        showNomenclaturaBtn.addEventListener('click', () => {
            nomenclaturaFields.classList.toggle('hidden');
        });

        // Búsqueda Avanzada Button
        showAdvancedSearchBtn.addEventListener('click', () => {
            advancedSearchFields.classList.toggle('hidden');
        });
    </script>
</body>

</html>
